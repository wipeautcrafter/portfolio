import{AnimationClip as p,Bone as q,Box3 as r,BufferAttribute as s,BufferGeometry as t,ClampToEdgeWrapping as a,Color as u,DirectionalLight as v,DoubleSide as w,FileLoader as x,FrontSide as y,Group as z,ImageBitmapLoader as A,InterleavedBuffer as B,InterleavedBufferAttribute as C,Interpolant as b,InterpolateDiscrete as c,InterpolateLinear as d,Line as D,LineBasicMaterial as E,LineLoop as F,LineSegments as G,LinearFilter as e,LinearMipmapLinearFilter as f,LinearMipmapNearestFilter as g,Loader as h,LoaderUtils as H,Material as I,MathUtils as J,Matrix4 as K,Mesh as L,MeshBasicMaterial as M,MeshPhysicalMaterial as N,MeshStandardMaterial as i,MirroredRepeatWrapping as j,NearestFilter as k,NearestMipmapLinearFilter as l,NearestMipmapNearestFilter as m,NumberKeyframeTrack as O,Object3D as P,OrthographicCamera as Q,PerspectiveCamera as R,PointLight as S,Points as T,PointsMaterial as U,PropertyBinding as V,Quaternion as n,QuaternionKeyframeTrack as W,RepeatWrapping as o,Skeleton as X,SkinnedMesh as Y,Sphere as Z,SpotLight as $,TangentSpaceNormalMap as _,Texture as aa,TextureLoader as ab,TriangleFanDrawMode as ac,TriangleStripDrawMode as ad,Vector2 as ae,Vector3 as af,VectorKeyframeTrack as ag,sRGBEncoding as ah}from"./Three.min.js";class GLTFLoader extends h{constructor(a){super(a),this.dracoLoader=null,this.ktx2Loader=null,this.meshoptDecoder=null,this.pluginCallbacks=[],this.register(function(a){return new GLTFMaterialsClearcoatExtension(a)}),this.register(function(a){return new GLTFTextureBasisUExtension(a)}),this.register(function(a){return new GLTFTextureWebPExtension(a)}),this.register(function(a){return new GLTFMaterialsSheenExtension(a)}),this.register(function(a){return new GLTFMaterialsTransmissionExtension(a)}),this.register(function(a){return new GLTFMaterialsVolumeExtension(a)}),this.register(function(a){return new GLTFMaterialsIorExtension(a)}),this.register(function(a){return new GLTFMaterialsEmissiveStrengthExtension(a)}),this.register(function(a){return new GLTFMaterialsSpecularExtension(a)}),this.register(function(a){return new GLTFMaterialsIridescenceExtension(a)}),this.register(function(a){return new GLTFLightsExtension(a)}),this.register(function(a){return new GLTFMeshoptCompression(a)})}load(b,f,c,g){let h=this,d;d=""!==this.resourcePath?this.resourcePath:""!==this.path?this.path:H.extractUrlBase(b),this.manager.itemStart(b);let e=function(a){g?g(a):console.error(a),h.manager.itemError(b),h.manager.itemEnd(b)},a=new x(this.manager);a.setPath(this.path),a.setResponseType("arraybuffer"),a.setRequestHeader(this.requestHeader),a.setWithCredentials(this.withCredentials),a.load(b,function(a){try{h.parse(a,d,function(a){f(a),h.manager.itemEnd(b)},e)}catch(c){e(c)}},c,e)}setDRACOLoader(a){return this.dracoLoader=a,this}setDDSLoader(){throw new Error('THREE.GLTFLoader: "MSFT_texture_dds" no longer supported. Please update to "KHR_texture_basisu".')}setKTX2Loader(a){return this.ktx2Loader=a,this}setMeshoptDecoder(a){return this.meshoptDecoder=a,this}register(a){return -1===this.pluginCallbacks.indexOf(a)&&this.pluginCallbacks.push(a),this}unregister(a){return -1!==this.pluginCallbacks.indexOf(a)&&this.pluginCallbacks.splice(this.pluginCallbacks.indexOf(a),1),this}parse(d,l,m,e){let g,a={},h={};if("string"==typeof d)g=d;else{let n=H.decodeText(new Uint8Array(d,0,4));if(n===BINARY_EXTENSION_HEADER_MAGIC){try{a[EXTENSIONS.KHR_BINARY_GLTF]=new GLTFBinaryExtension(d)}catch(o){e&&e(o);return}g=a[EXTENSIONS.KHR_BINARY_GLTF].content}else g=H.decodeText(new Uint8Array(d))}let c=JSON.parse(g);if(void 0===c.asset||c.asset.version[0]<2){e&&e(new Error("THREE.GLTFLoader: Unsupported asset. glTF versions >=2.0 are supported."));return}let f=new GLTFParser(c,{path:l||this.resourcePath||"",crossOrigin:this.crossOrigin,requestHeader:this.requestHeader,manager:this.manager,ktx2Loader:this.ktx2Loader,meshoptDecoder:this.meshoptDecoder});f.fileLoader.setRequestHeader(this.requestHeader);for(let i=0;i<this.pluginCallbacks.length;i++){let j=this.pluginCallbacks[i](f);h[j.name]=j,a[j.name]=!0}if(c.extensionsUsed)for(let k=0;k<c.extensionsUsed.length;++k){let b=c.extensionsUsed[k],p=c.extensionsRequired||[];switch(b){case EXTENSIONS.KHR_MATERIALS_UNLIT:a[b]=new GLTFMaterialsUnlitExtension;break;case EXTENSIONS.KHR_MATERIALS_PBR_SPECULAR_GLOSSINESS:a[b]=new GLTFMaterialsPbrSpecularGlossinessExtension;break;case EXTENSIONS.KHR_DRACO_MESH_COMPRESSION:a[b]=new GLTFDracoMeshCompressionExtension(c,this.dracoLoader);break;case EXTENSIONS.KHR_TEXTURE_TRANSFORM:a[b]=new GLTFTextureTransformExtension;break;case EXTENSIONS.KHR_MESH_QUANTIZATION:a[b]=new GLTFMeshQuantizationExtension;break;default:p.indexOf(b)>=0&& void 0===h[b]&&console.warn('THREE.GLTFLoader: Unknown extension "'+b+'".')}}f.setExtensions(a),f.setPlugins(h),f.parse(m,e)}parseAsync(a,b){let c=this;return new Promise(function(d,e){c.parse(a,b,d,e)})}}function GLTFRegistry(){let a={};return{get:function(b){return a[b]},add:function(b,c){a[b]=c},remove:function(b){delete a[b]},removeAll:function(){a={}}}}let EXTENSIONS={KHR_BINARY_GLTF:"KHR_binary_glTF",KHR_DRACO_MESH_COMPRESSION:"KHR_draco_mesh_compression",KHR_LIGHTS_PUNCTUAL:"KHR_lights_punctual",KHR_MATERIALS_CLEARCOAT:"KHR_materials_clearcoat",KHR_MATERIALS_IOR:"KHR_materials_ior",KHR_MATERIALS_PBR_SPECULAR_GLOSSINESS:"KHR_materials_pbrSpecularGlossiness",KHR_MATERIALS_SHEEN:"KHR_materials_sheen",KHR_MATERIALS_SPECULAR:"KHR_materials_specular",KHR_MATERIALS_TRANSMISSION:"KHR_materials_transmission",KHR_MATERIALS_IRIDESCENCE:"KHR_materials_iridescence",KHR_MATERIALS_UNLIT:"KHR_materials_unlit",KHR_MATERIALS_VOLUME:"KHR_materials_volume",KHR_TEXTURE_BASISU:"KHR_texture_basisu",KHR_TEXTURE_TRANSFORM:"KHR_texture_transform",KHR_MESH_QUANTIZATION:"KHR_mesh_quantization",KHR_MATERIALS_EMISSIVE_STRENGTH:"KHR_materials_emissive_strength",EXT_TEXTURE_WEBP:"EXT_texture_webp",EXT_MESHOPT_COMPRESSION:"EXT_meshopt_compression"};class GLTFLightsExtension{constructor(a){this.parser=a,this.name=EXTENSIONS.KHR_LIGHTS_PUNCTUAL,this.cache={refs:{},uses:{}}}_markDefs(){let d=this.parser,c=this.parser.json.nodes||[];for(let b=0,e=c.length;b<e;b++){let a=c[b];a.extensions&&a.extensions[this.name]&& void 0!==a.extensions[this.name].light&&d._addNodeRef(this.cache,a.extensions[this.name].light)}}_loadLight(f){let d=this.parser,g="light:"+f,c=d.cache.get(g);if(c)return c;let h=d.json,j=h.extensions&&h.extensions[this.name]||{},k=j.lights||[],a=k[f],b,e=new u(16777215);void 0!==a.color&&e.fromArray(a.color);let i=void 0!==a.range?a.range:0;switch(a.type){case"directional":(b=new v(e)).target.position.set(0,0,-1),b.add(b.target);break;case"point":(b=new S(e)).distance=i;break;case"spot":(b=new $(e)).distance=i,a.spot=a.spot||{},a.spot.innerConeAngle=void 0!==a.spot.innerConeAngle?a.spot.innerConeAngle:0,a.spot.outerConeAngle=void 0!==a.spot.outerConeAngle?a.spot.outerConeAngle:Math.PI/4,b.angle=a.spot.outerConeAngle,b.penumbra=1-a.spot.innerConeAngle/a.spot.outerConeAngle,b.target.position.set(0,0,-1),b.add(b.target);break;default:throw new Error("THREE.GLTFLoader: Unexpected light type: "+a.type)}return b.position.set(0,0,0),b.decay=2,void 0!==a.intensity&&(b.intensity=a.intensity),b.name=d.createUniqueName(a.name||"light_"+f),c=Promise.resolve(b),d.cache.add(g,c),c}createNodeAttachment(c){let g=this,d=this.parser,e=d.json,a=e.nodes[c],f=a.extensions&&a.extensions[this.name]||{},b=f.light;return void 0===b?null:this._loadLight(b).then(function(a){return d._getNodeRef(g.cache,b,a)})}}class GLTFMaterialsUnlitExtension{constructor(){this.name=EXTENSIONS.KHR_MATERIALS_UNLIT}getMaterialType(){return M}extendParams(a,e,f){let c=[];a.color=new u(1,1,1),a.opacity=1;let b=e.pbrMetallicRoughness;if(b){if(Array.isArray(b.baseColorFactor)){let d=b.baseColorFactor;a.color.fromArray(d),a.opacity=d[3]}void 0!==b.baseColorTexture&&c.push(f.assignTexture(a,"map",b.baseColorTexture,ah))}return Promise.all(c)}}class GLTFMaterialsEmissiveStrengthExtension{constructor(a){this.parser=a,this.name=EXTENSIONS.KHR_MATERIALS_EMISSIVE_STRENGTH}extendMaterialParams(c,d){let e=this.parser,a=e.json.materials[c];if(!a.extensions||!a.extensions[this.name])return Promise.resolve();let b=a.extensions[this.name].emissiveStrength;return void 0!==b&&(d.emissiveIntensity=b),Promise.resolve()}}class GLTFMaterialsClearcoatExtension{constructor(a){this.parser=a,this.name=EXTENSIONS.KHR_MATERIALS_CLEARCOAT}getMaterialType(b){let c=this.parser,a=c.json.materials[b];return a.extensions&&a.extensions[this.name]?N:null}extendMaterialParams(g,b){let c=this.parser,e=c.json.materials[g];if(!e.extensions||!e.extensions[this.name])return Promise.resolve();let d=[],a=e.extensions[this.name];if(void 0!==a.clearcoatFactor&&(b.clearcoat=a.clearcoatFactor),void 0!==a.clearcoatTexture&&d.push(c.assignTexture(b,"clearcoatMap",a.clearcoatTexture)),void 0!==a.clearcoatRoughnessFactor&&(b.clearcoatRoughness=a.clearcoatRoughnessFactor),void 0!==a.clearcoatRoughnessTexture&&d.push(c.assignTexture(b,"clearcoatRoughnessMap",a.clearcoatRoughnessTexture)),void 0!==a.clearcoatNormalTexture&&(d.push(c.assignTexture(b,"clearcoatNormalMap",a.clearcoatNormalTexture)),void 0!==a.clearcoatNormalTexture.scale)){let f=a.clearcoatNormalTexture.scale;b.clearcoatNormalScale=new ae(f,f)}return Promise.all(d)}}class GLTFMaterialsIridescenceExtension{constructor(a){this.parser=a,this.name=EXTENSIONS.KHR_MATERIALS_IRIDESCENCE}getMaterialType(b){let c=this.parser,a=c.json.materials[b];return a.extensions&&a.extensions[this.name]?N:null}extendMaterialParams(f,b){let c=this.parser,d=c.json.materials[f];if(!d.extensions||!d.extensions[this.name])return Promise.resolve();let e=[],a=d.extensions[this.name];return void 0!==a.iridescenceFactor&&(b.iridescence=a.iridescenceFactor),void 0!==a.iridescenceTexture&&e.push(c.assignTexture(b,"iridescenceMap",a.iridescenceTexture)),void 0!==a.iridescenceIor&&(b.iridescenceIOR=a.iridescenceIor),void 0===b.iridescenceThicknessRange&&(b.iridescenceThicknessRange=[100,400]),void 0!==a.iridescenceThicknessMinimum&&(b.iridescenceThicknessRange[0]=a.iridescenceThicknessMinimum),void 0!==a.iridescenceThicknessMaximum&&(b.iridescenceThicknessRange[1]=a.iridescenceThicknessMaximum),void 0!==a.iridescenceThicknessTexture&&e.push(c.assignTexture(b,"iridescenceThicknessMap",a.iridescenceThicknessTexture)),Promise.all(e)}}class GLTFMaterialsSheenExtension{constructor(a){this.parser=a,this.name=EXTENSIONS.KHR_MATERIALS_SHEEN}getMaterialType(b){let c=this.parser,a=c.json.materials[b];return a.extensions&&a.extensions[this.name]?N:null}extendMaterialParams(f,b){let c=this.parser,d=c.json.materials[f];if(!d.extensions||!d.extensions[this.name])return Promise.resolve();let e=[];b.sheenColor=new u(0,0,0),b.sheenRoughness=0,b.sheen=1;let a=d.extensions[this.name];return void 0!==a.sheenColorFactor&&b.sheenColor.fromArray(a.sheenColorFactor),void 0!==a.sheenRoughnessFactor&&(b.sheenRoughness=a.sheenRoughnessFactor),void 0!==a.sheenColorTexture&&e.push(c.assignTexture(b,"sheenColorMap",a.sheenColorTexture,ah)),void 0!==a.sheenRoughnessTexture&&e.push(c.assignTexture(b,"sheenRoughnessMap",a.sheenRoughnessTexture)),Promise.all(e)}}class GLTFMaterialsTransmissionExtension{constructor(a){this.parser=a,this.name=EXTENSIONS.KHR_MATERIALS_TRANSMISSION}getMaterialType(b){let c=this.parser,a=c.json.materials[b];return a.extensions&&a.extensions[this.name]?N:null}extendMaterialParams(f,c){let d=this.parser,b=d.json.materials[f];if(!b.extensions||!b.extensions[this.name])return Promise.resolve();let e=[],a=b.extensions[this.name];return void 0!==a.transmissionFactor&&(c.transmission=a.transmissionFactor),void 0!==a.transmissionTexture&&e.push(d.assignTexture(c,"transmissionMap",a.transmissionTexture)),Promise.all(e)}}class GLTFMaterialsVolumeExtension{constructor(a){this.parser=a,this.name=EXTENSIONS.KHR_MATERIALS_VOLUME}getMaterialType(b){let c=this.parser,a=c.json.materials[b];return a.extensions&&a.extensions[this.name]?N:null}extendMaterialParams(g,b){let e=this.parser,c=e.json.materials[g];if(!c.extensions||!c.extensions[this.name])return Promise.resolve();let f=[],a=c.extensions[this.name];b.thickness=void 0!==a.thicknessFactor?a.thicknessFactor:0,void 0!==a.thicknessTexture&&f.push(e.assignTexture(b,"thicknessMap",a.thicknessTexture)),b.attenuationDistance=a.attenuationDistance||0;let d=a.attenuationColor||[1,1,1];return b.attenuationColor=new u(d[0],d[1],d[2]),Promise.all(f)}}class GLTFMaterialsIorExtension{constructor(a){this.parser=a,this.name=EXTENSIONS.KHR_MATERIALS_IOR}getMaterialType(b){let c=this.parser,a=c.json.materials[b];return a.extensions&&a.extensions[this.name]?N:null}extendMaterialParams(c,d){let e=this.parser,a=e.json.materials[c];if(!a.extensions||!a.extensions[this.name])return Promise.resolve();let b=a.extensions[this.name];return d.ior=void 0!==b.ior?b.ior:1.5,Promise.resolve()}}class GLTFMaterialsSpecularExtension{constructor(a){this.parser=a,this.name=EXTENSIONS.KHR_MATERIALS_SPECULAR}getMaterialType(b){let c=this.parser,a=c.json.materials[b];return a.extensions&&a.extensions[this.name]?N:null}extendMaterialParams(g,b){let c=this.parser,d=c.json.materials[g];if(!d.extensions||!d.extensions[this.name])return Promise.resolve();let e=[],a=d.extensions[this.name];b.specularIntensity=void 0!==a.specularFactor?a.specularFactor:1,void 0!==a.specularTexture&&e.push(c.assignTexture(b,"specularIntensityMap",a.specularTexture));let f=a.specularColorFactor||[1,1,1];return b.specularColor=new u(f[0],f[1],f[2]),void 0!==a.specularColorTexture&&e.push(c.assignTexture(b,"specularColorMap",a.specularColorTexture,ah)),Promise.all(e)}}class GLTFTextureBasisUExtension{constructor(a){this.parser=a,this.name=EXTENSIONS.KHR_TEXTURE_BASISU}loadTexture(d){let a=this.parser,b=a.json,c=b.textures[d];if(!c.extensions||!c.extensions[this.name])return null;let f=c.extensions[this.name],e=a.options.ktx2Loader;if(!e){if(!(b.extensionsRequired&&b.extensionsRequired.indexOf(this.name)>=0))return null;throw new Error("THREE.GLTFLoader: setKTX2Loader must be called before loading KTX2 textures")}return a.loadTextureImage(d,f.source,e)}}class GLTFTextureWebPExtension{constructor(a){this.parser=a,this.name=EXTENSIONS.EXT_TEXTURE_WEBP,this.isSupported=null}loadTexture(g){let c=this.name,a=this.parser,d=a.json,b=d.textures[g];if(!b.extensions||!b.extensions[c])return null;let h=b.extensions[c],e=d.images[h.source],i=a.textureLoader;if(e.uri){let f=a.options.manager.getHandler(e.uri);null!==f&&(i=f)}return this.detectSupport().then(function(b){if(b)return a.loadTextureImage(g,h.source,i);if(d.extensionsRequired&&d.extensionsRequired.indexOf(c)>=0)throw new Error("THREE.GLTFLoader: WebP required by asset but unsupported.");return a.loadTexture(g)})}detectSupport(){return this.isSupported||(this.isSupported=new Promise(function(b){let a=new Image;a.src="data:image/webp;base64,UklGRiIAAABXRUJQVlA4IBYAAAAwAQCdASoBAAEADsD+JaQAA3AAAAAA",a.onload=a.onerror=function(){b(1===a.height)}})),this.isSupported}}class GLTFMeshoptCompression{constructor(a){this.name=EXTENSIONS.EXT_MESHOPT_COMPRESSION,this.parser=a}loadBufferView(d){let a=this.parser.json,b=a.bufferViews[d];if(!b.extensions||!b.extensions[this.name])return null;{let e=b.extensions[this.name],f=this.parser.getDependency("buffer",e.buffer),c=this.parser.options.meshoptDecoder;if(!c||!c.supported){if(!(a.extensionsRequired&&a.extensionsRequired.indexOf(this.name)>=0))return null;throw new Error("THREE.GLTFLoader: setMeshoptDecoder must be called before loading compressed files")}return Promise.all([f,c.ready]).then(function(f){let g=e.byteOffset||0,h=e.byteLength||0,a=e.count,b=e.byteStride,d=new ArrayBuffer(a*b),i=new Uint8Array(f[0],g,h);return c.decodeGltfBuffer(new Uint8Array(d),a,b,i,e.mode,e.filter),d})}}}let BINARY_EXTENSION_HEADER_MAGIC="glTF",BINARY_EXTENSION_HEADER_LENGTH=12,BINARY_EXTENSION_CHUNK_TYPES={JSON:1313821514,BIN:5130562};class GLTFBinaryExtension{constructor(b){this.name=EXTENSIONS.KHR_BINARY_GLTF,this.content=null,this.body=null;let d=new DataView(b,0,BINARY_EXTENSION_HEADER_LENGTH);if(this.header={magic:H.decodeText(new Uint8Array(b.slice(0,4))),version:d.getUint32(4,!0),length:d.getUint32(8,!0)},this.header.magic!==BINARY_EXTENSION_HEADER_MAGIC)throw new Error("THREE.GLTFLoader: Unsupported glTF-Binary header.");if(this.header.version<2)throw new Error("THREE.GLTFLoader: Legacy binary file detected.");let h=this.header.length-BINARY_EXTENSION_HEADER_LENGTH,e=new DataView(b,BINARY_EXTENSION_HEADER_LENGTH),a=0;for(;a<h;){let c=e.getUint32(a,!0);a+=4;let f=e.getUint32(a,!0);if(a+=4,f===BINARY_EXTENSION_CHUNK_TYPES.JSON){let i=new Uint8Array(b,BINARY_EXTENSION_HEADER_LENGTH+a,c);this.content=H.decodeText(i)}else if(f===BINARY_EXTENSION_CHUNK_TYPES.BIN){let g=BINARY_EXTENSION_HEADER_LENGTH+a;this.body=b.slice(g,g+c)}a+=c}if(null===this.content)throw new Error("THREE.GLTFLoader: JSON content not found.")}}class GLTFDracoMeshCompressionExtension{constructor(b,a){if(!a)throw new Error("THREE.GLTFLoader: No DRACOLoader instance provided.");this.name=EXTENSIONS.KHR_DRACO_MESH_COMPRESSION,this.json=b,this.dracoLoader=a,this.dracoLoader.preload()}decodePrimitive(a,g){let h=this.json,o=this.dracoLoader,i=a.extensions[this.name].bufferView,c=a.extensions[this.name].attributes,j={},k={},l={};for(let d in c){let m=ATTRIBUTES[d]||d.toLowerCase();j[m]=c[d]}for(let b in a.attributes){let e=ATTRIBUTES[b]||b.toLowerCase();if(void 0!==c[b]){let f=h.accessors[a.attributes[b]],n=WEBGL_COMPONENT_TYPES[f.componentType];l[e]=n,k[e]=!0===f.normalized}}return g.getDependency("bufferView",i).then(function(a){return new Promise(function(b){o.decodeDracoFile(a,function(a){for(let c in a.attributes){let e=a.attributes[c],d=k[c];void 0!==d&&(e.normalized=d)}b(a)},j,l)})})}}class GLTFTextureTransformExtension{constructor(){this.name=EXTENSIONS.KHR_TEXTURE_TRANSFORM}extendTexture(b,a){return void 0!==a.texCoord&&console.warn('THREE.GLTFLoader: Custom UV sets in "'+this.name+'" extension not yet supported.'),void 0===a.offset&& void 0===a.rotation&& void 0===a.scale||(b=b.clone(),void 0!==a.offset&&b.offset.fromArray(a.offset),void 0!==a.rotation&&(b.rotation=a.rotation),void 0!==a.scale&&b.repeat.fromArray(a.scale),b.needsUpdate=!0),b}}class GLTFMeshStandardSGMaterial extends i{constructor(a){super(),this.isGLTFSpecularGlossinessMaterial=!0;let b={specular:{value:new u().setHex(16777215)},glossiness:{value:1},specularMap:{value:null},glossinessMap:{value:null}};this._extraUniforms=b,this.onBeforeCompile=function(a){for(let c in b)a.uniforms[c]=b[c];a.fragmentShader=a.fragmentShader.replace("uniform float roughness;","uniform vec3 specular;").replace("uniform float metalness;","uniform float glossiness;").replace("#include <roughnessmap_pars_fragment>","#ifdef USE_SPECULARMAP\n	uniform sampler2D specularMap;\n#endif").replace("#include <metalnessmap_pars_fragment>","#ifdef USE_GLOSSINESSMAP\n	uniform sampler2D glossinessMap;\n#endif").replace("#include <roughnessmap_fragment>","vec3 specularFactor = specular;\n#ifdef USE_SPECULARMAP\n	vec4 texelSpecular = texture2D( specularMap, vUv );\n	// reads channel RGB, compatible with a glTF Specular-Glossiness (RGBA) texture\n	specularFactor *= texelSpecular.rgb;\n#endif").replace("#include <metalnessmap_fragment>","float glossinessFactor = glossiness;\n#ifdef USE_GLOSSINESSMAP\n	vec4 texelGlossiness = texture2D( glossinessMap, vUv );\n	// reads channel A, compatible with a glTF Specular-Glossiness (RGBA) texture\n	glossinessFactor *= texelGlossiness.a;\n#endif").replace("#include <lights_physical_fragment>","PhysicalMaterial material;\nmaterial.diffuseColor = diffuseColor.rgb * ( 1. - max( specularFactor.r, max( specularFactor.g, specularFactor.b ) ) );\nvec3 dxy = max( abs( dFdx( geometryNormal ) ), abs( dFdy( geometryNormal ) ) );\nfloat geometryRoughness = max( max( dxy.x, dxy.y ), dxy.z );\nmaterial.roughness = max( 1.0 - glossinessFactor, 0.0525 ); // 0.0525 corresponds to the base mip of a 256 cubemap.\nmaterial.roughness += geometryRoughness;\nmaterial.roughness = min( material.roughness, 1.0 );\nmaterial.specularColor = specularFactor;")},Object.defineProperties(this,{specular:{get:function(){return b.specular.value},set:function(a){b.specular.value=a}},specularMap:{get:function(){return b.specularMap.value},set:function(a){b.specularMap.value=a,a?this.defines.USE_SPECULARMAP="":delete this.defines.USE_SPECULARMAP}},glossiness:{get:function(){return b.glossiness.value},set:function(a){b.glossiness.value=a}},glossinessMap:{get:function(){return b.glossinessMap.value},set:function(a){b.glossinessMap.value=a,a?(this.defines.USE_GLOSSINESSMAP="",this.defines.USE_UV=""):(delete this.defines.USE_GLOSSINESSMAP,delete this.defines.USE_UV)}}}),delete this.metalness,delete this.roughness,delete this.metalnessMap,delete this.roughnessMap,this.setValues(a)}copy(a){return super.copy(a),this.specularMap=a.specularMap,this.specular.copy(a.specular),this.glossinessMap=a.glossinessMap,this.glossiness=a.glossiness,delete this.metalness,delete this.roughness,delete this.metalnessMap,delete this.roughnessMap,this}}class GLTFMaterialsPbrSpecularGlossinessExtension{constructor(){this.name=EXTENSIONS.KHR_MATERIALS_PBR_SPECULAR_GLOSSINESS,this.specularGlossinessParams=["color","map","lightMap","lightMapIntensity","aoMap","aoMapIntensity","emissive","emissiveIntensity","emissiveMap","bumpMap","bumpScale","normalMap","normalMapType","displacementMap","displacementScale","displacementBias","specularMap","specular","glossinessMap","glossiness","alphaMap","envMap","envMapIntensity"]}getMaterialType(){return GLTFMeshStandardSGMaterial}extendParams(a,g,d){let b=g.extensions[this.name];a.color=new u(1,1,1),a.opacity=1;let c=[];if(Array.isArray(b.diffuseFactor)){let e=b.diffuseFactor;a.color.fromArray(e),a.opacity=e[3]}if(void 0!==b.diffuseTexture&&c.push(d.assignTexture(a,"map",b.diffuseTexture,ah)),a.emissive=new u(0,0,0),a.glossiness=void 0!==b.glossinessFactor?b.glossinessFactor:1,a.specular=new u(1,1,1),Array.isArray(b.specularFactor)&&a.specular.fromArray(b.specularFactor),void 0!==b.specularGlossinessTexture){let f=b.specularGlossinessTexture;c.push(d.assignTexture(a,"glossinessMap",f)),c.push(d.assignTexture(a,"specularMap",f,ah))}return Promise.all(c)}createMaterial(b){let a=new GLTFMeshStandardSGMaterial(b);return a.fog=!0,a.color=b.color,a.map=void 0===b.map?null:b.map,a.lightMap=null,a.lightMapIntensity=1,a.aoMap=void 0===b.aoMap?null:b.aoMap,a.aoMapIntensity=1,a.emissive=b.emissive,a.emissiveIntensity=void 0===b.emissiveIntensity?1:b.emissiveIntensity,a.emissiveMap=void 0===b.emissiveMap?null:b.emissiveMap,a.bumpMap=void 0===b.bumpMap?null:b.bumpMap,a.bumpScale=1,a.normalMap=void 0===b.normalMap?null:b.normalMap,a.normalMapType=_,b.normalScale&&(a.normalScale=b.normalScale),a.displacementMap=null,a.displacementScale=1,a.displacementBias=0,a.specularMap=void 0===b.specularMap?null:b.specularMap,a.specular=b.specular,a.glossinessMap=void 0===b.glossinessMap?null:b.glossinessMap,a.glossiness=b.glossiness,a.alphaMap=null,a.envMap=void 0===b.envMap?null:b.envMap,a.envMapIntensity=1,a}}class GLTFMeshQuantizationExtension{constructor(){this.name=EXTENSIONS.KHR_MESH_QUANTIZATION}}class GLTFCubicSplineInterpolant extends b{constructor(a,b,c,d){super(a,b,c,d)}copySampleValue_(d){let c=this.resultBuffer,e=this.sampleValues,b=this.valueSize,f=d*b*3+b;for(let a=0;a!==b;a++)c[a]=e[f+a];return c}}GLTFCubicSplineInterpolant.prototype.interpolate_=function(o,h,p,q){let i=this.resultBuffer,c=this.sampleValues,b=this.valueSize,r=2*b,j=3*b,f=q-h,d=(p-h)/f,e=d*d,k=e*d,g=o*j,l=g-j,m=-2*k+3*e,n=k-e,s=1-m,t=n-e+d;for(let a=0;a!==b;a++){let u=c[l+a+b],v=c[l+a+r]*f,w=c[g+a+b],x=c[g+a]*f;i[a]=s*u+t*v+m*w+n*x}return i};let _q=new n;class GLTFCubicSplineQuaternionInterpolant extends GLTFCubicSplineInterpolant{interpolate_(b,c,d,e){let a=super.interpolate_(b,c,d,e);return _q.fromArray(a).normalize().toArray(a),a}}let WEBGL_CONSTANTS={FLOAT:5126,FLOAT_MAT3:35675,FLOAT_MAT4:35676,FLOAT_VEC2:35664,FLOAT_VEC3:35665,FLOAT_VEC4:35666,LINEAR:9729,REPEAT:10497,SAMPLER_2D:35678,POINTS:0,LINES:1,LINE_LOOP:2,LINE_STRIP:3,TRIANGLES:4,TRIANGLE_STRIP:5,TRIANGLE_FAN:6,UNSIGNED_BYTE:5121,UNSIGNED_SHORT:5123},WEBGL_COMPONENT_TYPES={5120:Int8Array,5121:Uint8Array,5122:Int16Array,5123:Uint16Array,5125:Uint32Array,5126:Float32Array},WEBGL_FILTERS={9728:k,9729:e,9984:m,9985:g,9986:l,9987:f},WEBGL_WRAPPINGS={33071:a,33648:j,10497:o},WEBGL_TYPE_SIZES={SCALAR:1,VEC2:2,VEC3:3,VEC4:4,MAT2:4,MAT3:9,MAT4:16},ATTRIBUTES={POSITION:"position",NORMAL:"normal",TANGENT:"tangent",TEXCOORD_0:"uv",TEXCOORD_1:"uv2",COLOR_0:"color",WEIGHTS_0:"skinWeight",JOINTS_0:"skinIndex"},PATH_PROPERTIES={scale:"scale",translation:"position",rotation:"quaternion",weights:"morphTargetInfluences"},INTERPOLATION={CUBICSPLINE:void 0,LINEAR:d,STEP:c},ALPHA_MODES={OPAQUE:"OPAQUE",MASK:"MASK",BLEND:"BLEND"};function createDefaultMaterial(a){return void 0===a.DefaultMaterial&&(a.DefaultMaterial=new i({color:16777215,emissive:0,metalness:1,roughness:1,transparent:!1,depthTest:!0,side:y})),a.DefaultMaterial}function addUnknownExtensionsToUserData(d,a,c){for(let b in c.extensions)void 0===d[b]&&(a.userData.gltfExtensions=a.userData.gltfExtensions||{},a.userData.gltfExtensions[b]=c.extensions[b])}function assignExtrasToUserData(b,a){void 0!==a.extras&&("object"==typeof a.extras?Object.assign(b.userData,a.extras):console.warn("THREE.GLTFLoader: Ignoring primitive type .extras, "+a.extras))}function addMorphTargets(b,c,g){let d=!1,e=!1,f=!1;for(let h=0,n=c.length;h<n;h++){let i=c[h];if(void 0!==i.POSITION&&(d=!0),void 0!==i.NORMAL&&(e=!0),void 0!==i.COLOR_0&&(f=!0),d&&e&&f)break}if(!d&&!e&&!f)return Promise.resolve(b);let k=[],l=[],m=[];for(let j=0,o=c.length;j<o;j++){let a=c[j];if(d){let p=void 0!==a.POSITION?g.getDependency("accessor",a.POSITION):b.attributes.position;k.push(p)}if(e){let q=void 0!==a.NORMAL?g.getDependency("accessor",a.NORMAL):b.attributes.normal;l.push(q)}if(f){let r=void 0!==a.COLOR_0?g.getDependency("accessor",a.COLOR_0):b.attributes.color;m.push(r)}}return Promise.all([Promise.all(k),Promise.all(l),Promise.all(m)]).then(function(a){let c=a[0],g=a[1],h=a[2];return d&&(b.morphAttributes.position=c),e&&(b.morphAttributes.normal=g),f&&(b.morphAttributes.color=h),b.morphTargetsRelative=!0,b})}function updateMorphTargets(b,a){if(b.updateMorphTargets(),void 0!==a.weights)for(let c=0,f=a.weights.length;c<f;c++)b.morphTargetInfluences[c]=a.weights[c];if(a.extras&&Array.isArray(a.extras.targetNames)){let e=a.extras.targetNames;if(b.morphTargetInfluences.length===e.length){b.morphTargetDictionary={};for(let d=0,g=e.length;d<g;d++)b.morphTargetDictionary[e[d]]=d}else console.warn("THREE.GLTFLoader: Invalid extras.targetNames length. Ignoring names.")}}function createPrimitiveKey(a){let b=a.extensions&&a.extensions[EXTENSIONS.KHR_DRACO_MESH_COMPRESSION];return b?"draco:"+b.bufferView+":"+b.indices+":"+createAttributesKey(b.attributes):a.indices+":"+createAttributesKey(a.attributes)+":"+a.mode}function createAttributesKey(c){let d="",b=Object.keys(c).sort();for(let a=0,e=b.length;a<e;a++)d+=b[a]+":"+c[b[a]]+";";return d}function getNormalizedComponentScale(a){switch(a){case Int8Array:return 1/127;case Uint8Array:return 1/255;case Int16Array:return 1/32767;case Uint16Array:return 1/65535;default:throw new Error("THREE.GLTFLoader: Unsupported normalized accessor component type.")}}function getImageURIMimeType(a){return a.search(/\.jpe?g($|\?)/i)>0||0===a.search(/^data\:image\/jpeg/)?"image/jpeg":a.search(/\.webp($|\?)/i)>0||0===a.search(/^data\:image\/webp/)?"image/webp":"image/png"}class GLTFParser{constructor(b={},c={}){this.json=b,this.extensions={},this.plugins={},this.options=c,this.cache=new GLTFRegistry,this.associations=new Map,this.primitiveCache={},this.meshCache={refs:{},uses:{}},this.cameraCache={refs:{},uses:{}},this.lightCache={refs:{},uses:{}},this.sourceCache={},this.textureCache={},this.nodeNamesUsed={};let d=!0===/^((?!chrome|android).)*safari/i.test(navigator.userAgent),a=navigator.userAgent.indexOf("Firefox")> -1,e=a?navigator.userAgent.match(/Firefox\/([0-9]+)\./)[1]:-1;"undefined"==typeof createImageBitmap||d||a&&e<98?this.textureLoader=new ab(this.options.manager):this.textureLoader=new A(this.options.manager),this.textureLoader.setCrossOrigin(this.options.crossOrigin),this.textureLoader.setRequestHeader(this.options.requestHeader),this.fileLoader=new x(this.options.manager),this.fileLoader.setResponseType("arraybuffer"),"use-credentials"===this.options.crossOrigin&&this.fileLoader.setWithCredentials(!0)}setExtensions(a){this.extensions=a}setPlugins(a){this.plugins=a}parse(b,a){let c=this,d=this.json,e=this.extensions;this.cache.removeAll(),this._invokeAll(function(a){return a._markDefs&&a._markDefs()}),Promise.all(this._invokeAll(function(a){return a.beforeRoot&&a.beforeRoot()})).then(function(){return Promise.all([c.getDependencies("scene"),c.getDependencies("animation"),c.getDependencies("camera"),])}).then(function(a){let f={scene:a[0][d.scene||0],scenes:a[0],animations:a[1],cameras:a[2],asset:d.asset,parser:c,userData:{}};addUnknownExtensionsToUserData(e,f,d),assignExtrasToUserData(f,d),Promise.all(c._invokeAll(function(a){return a.afterRoot&&a.afterRoot(f)})).then(function(){b(f)})}).catch(a)}_markDefs(){let b=this.json.nodes||[],f=this.json.skins||[],h=this.json.meshes||[];for(let c=0,i=f.length;c<i;c++){let g=f[c].joints;for(let d=0,j=g.length;d<j;d++)b[g[d]].isBone=!0}for(let e=0,k=b.length;e<k;e++){let a=b[e];void 0!==a.mesh&&(this._addNodeRef(this.meshCache,a.mesh),void 0!==a.skin&&(h[a.mesh].isSkinnedMesh=!0)),void 0!==a.camera&&this._addNodeRef(this.cameraCache,a.camera)}}_addNodeRef(b,a){void 0!==a&&(void 0===b.refs[a]&&(b.refs[a]=b.uses[a]=0),b.refs[a]++)}_getNodeRef(c,d,a){if(c.refs[d]<=1)return a;let b=a.clone(),e=(a,b)=>{let c=this.associations.get(a);for(let[d,f]of(null!=c&&this.associations.set(b,c),a.children.entries()))e(f,b.children[d])};return e(a,b),b.name+="_instance_"+c.uses[d]++,b}_invokeOne(d){let a=Object.values(this.plugins);a.push(this);for(let b=0;b<a.length;b++){let c=d(a[b]);if(c)return c}return null}_invokeAll(e){let a=Object.values(this.plugins);a.unshift(this);let c=[];for(let b=0;b<a.length;b++){let d=e(a[b]);d&&c.push(d)}return c}getDependency(c,b){let d=c+":"+b,a=this.cache.get(d);if(!a){switch(c){case"scene":a=this.loadScene(b);break;case"node":a=this.loadNode(b);break;case"mesh":a=this._invokeOne(function(a){return a.loadMesh&&a.loadMesh(b)});break;case"accessor":a=this.loadAccessor(b);break;case"bufferView":a=this._invokeOne(function(a){return a.loadBufferView&&a.loadBufferView(b)});break;case"buffer":a=this.loadBuffer(b);break;case"material":a=this._invokeOne(function(a){return a.loadMaterial&&a.loadMaterial(b)});break;case"texture":a=this._invokeOne(function(a){return a.loadTexture&&a.loadTexture(b)});break;case"skin":a=this.loadSkin(b);break;case"animation":a=this._invokeOne(function(a){return a.loadAnimation&&a.loadAnimation(b)});break;case"camera":a=this.loadCamera(b);break;default:throw new Error("Unknown type: "+c)}this.cache.add(d,a)}return a}getDependencies(a){let b=this.cache.get(a);if(!b){let d=this,c=this.json[a+("mesh"===a?"es":"s")]||[];b=Promise.all(c.map(function(c,b){return d.getDependency(a,b)})),this.cache.add(a,b)}return b}loadBuffer(b){let a=this.json.buffers[b],c=this.fileLoader;if(a.type&&"arraybuffer"!==a.type)throw new Error("THREE.GLTFLoader: "+a.type+" buffer type is not supported.");if(void 0===a.uri&&0===b)return Promise.resolve(this.extensions[EXTENSIONS.KHR_BINARY_GLTF].body);let d=this.options;return new Promise(function(b,e){c.load(H.resolveURL(a.uri,d.path),b,void 0,function(){e(new Error('THREE.GLTFLoader: Failed to load buffer "'+a.uri+'".'))})})}loadBufferView(a){let b=this.json.bufferViews[a];return this.getDependency("buffer",b.buffer).then(function(c){let d=b.byteLength||0,a=b.byteOffset||0;return c.slice(a,a+d)})}loadAccessor(c){let d=this,e=this.json,a=this.json.accessors[c];if(void 0===a.bufferView&& void 0===a.sparse)return Promise.resolve(null);let b=[];return void 0!==a.bufferView?b.push(this.getDependency("bufferView",a.bufferView)):b.push(null),void 0!==a.sparse&&(b.push(this.getDependency("bufferView",a.sparse.indices.bufferView)),b.push(this.getDependency("bufferView",a.sparse.values.bufferView))),Promise.all(b).then(function(o){let i=o[0],b=WEBGL_TYPE_SIZES[a.type],h=WEBGL_COMPONENT_TYPES[a.componentType],j=h.BYTES_PER_ELEMENT,p=a.byteOffset||0,f=void 0!==a.bufferView?e.bufferViews[a.bufferView].byteStride:void 0,q=!0===a.normalized,k,c;if(f&&f!==j*b){let r=Math.floor(p/f),t="InterleavedBuffer:"+a.bufferView+":"+a.componentType+":"+r+":"+a.count,l=d.cache.get(t);l||(k=new h(i,r*f,a.count*f/j),l=new B(k,f/j),d.cache.add(t,l)),c=new C(l,b,p%f/j,q)}else k=null===i?new h(a.count*b):new h(i,p,a.count*b),c=new s(k,b,q);if(void 0!==a.sparse){let v=WEBGL_TYPE_SIZES.SCALAR,w=WEBGL_COMPONENT_TYPES[a.sparse.indices.componentType],x=a.sparse.indices.byteOffset||0,y=a.sparse.values.byteOffset||0,u=new w(o[1],x,a.sparse.count*v),m=new h(o[2],y,a.sparse.count*b);null!==i&&(c=new s(c.array.slice(),c.itemSize,c.normalized));for(let g=0,z=u.length;g<z;g++){let n=u[g];if(c.setX(n,m[g*b]),b>=2&&c.setY(n,m[g*b+1]),b>=3&&c.setZ(n,m[g*b+2]),b>=4&&c.setW(n,m[g*b+3]),b>=5)throw new Error("THREE.GLTFLoader: Unsupported itemSize in sparse BufferAttribute.")}}return c})}loadTexture(a){let b=this.json,g=this.options,h=b.textures[a],c=h.source,d=b.images[c],e=this.textureLoader;if(d.uri){let f=g.manager.getHandler(d.uri);null!==f&&(e=f)}return this.loadTextureImage(a,c,e)}loadTextureImage(h,b,i){let k=this,c=this.json,j=c.textures[h],d=c.images[b],a=(d.uri||d.bufferView)+":"+j.sampler;if(this.textureCache[a])return this.textureCache[a];let g=this.loadImageSource(b,i).then(function(a){a.flipY=!1,j.name&&(a.name=j.name);let d=c.samplers||{},b=d[j.sampler]||{};return a.magFilter=WEBGL_FILTERS[b.magFilter]||e,a.minFilter=WEBGL_FILTERS[b.minFilter]||f,a.wrapS=WEBGL_WRAPPINGS[b.wrapS]||o,a.wrapT=WEBGL_WRAPPINGS[b.wrapT]||o,k.associations.set(a,{textures:h}),a}).catch(function(){return null});return this.textureCache[a]=g,g}loadImageSource(a,f){let e=this.json,g=this.options;if(void 0!==this.sourceCache[a])return this.sourceCache[a].then(a=>a.clone());let b=e.images[a],h=self.URL||self.webkitURL,c=b.uri||"",i=!1;if(void 0!==b.bufferView)c=this.getDependency("bufferView",b.bufferView).then(function(a){i=!0;let d=new Blob([a],{type:b.mimeType});return c=h.createObjectURL(d)});else if(void 0===b.uri)throw new Error("THREE.GLTFLoader: Image "+a+" is missing URI and bufferView");let d=Promise.resolve(c).then(function(a){return new Promise(function(c,d){let b=c;!0===f.isImageBitmapLoader&&(b=function(b){let a=new aa(b);a.needsUpdate=!0,c(a)}),f.load(H.resolveURL(a,g.path),b,void 0,d)})}).then(function(a){return!0===i&&h.revokeObjectURL(c),a.userData.mimeType=b.mimeType||getImageURIMimeType(b.uri),a}).catch(function(a){throw console.error("THREE.GLTFLoader: Couldn't load texture",c),a});return this.sourceCache[a]=d,d}assignTexture(b,c,a,d){let e=this;return this.getDependency("texture",a.index).then(function(f){if(void 0===a.texCoord||0==a.texCoord||"aoMap"===c&&1==a.texCoord||console.warn("THREE.GLTFLoader: Custom UV set "+a.texCoord+" for texture "+c+" not yet supported."),e.extensions[EXTENSIONS.KHR_TEXTURE_TRANSFORM]){let g=void 0!==a.extensions?a.extensions[EXTENSIONS.KHR_TEXTURE_TRANSFORM]:void 0;if(g){let h=e.associations.get(f);f=e.extensions[EXTENSIONS.KHR_TEXTURE_TRANSFORM].extendTexture(f,g),e.associations.set(f,h)}}return void 0!==d&&(f.encoding=d),b[c]=f,f})}assignFinalMaterial(g){let d=g.geometry,a=g.material,h=void 0===d.attributes.tangent,i=void 0!==d.attributes.color,j=void 0===d.attributes.normal;if(g.isPoints){let k="PointsMaterial:"+a.uuid,c=this.cache.get(k);c||(c=new U,I.prototype.copy.call(c,a),c.color.copy(a.color),c.map=a.map,c.sizeAttenuation=!1,this.cache.add(k,c)),a=c}else if(g.isLine){let l="LineBasicMaterial:"+a.uuid,e=this.cache.get(l);e||(e=new E,I.prototype.copy.call(e,a),e.color.copy(a.color),this.cache.add(l,e)),a=e}if(h||i||j){let f="ClonedMaterial:"+a.uuid+":";a.isGLTFSpecularGlossinessMaterial&&(f+="specular-glossiness:"),h&&(f+="derivative-tangents:"),i&&(f+="vertex-colors:"),j&&(f+="flat-shading:");let b=this.cache.get(f);b||(b=a.clone(),i&&(b.vertexColors=!0),j&&(b.flatShading=!0),h&&(b.normalScale&&(b.normalScale.y*=-1),b.clearcoatNormalScale&&(b.clearcoatNormalScale.y*=-1)),this.cache.add(f,b),this.associations.set(b,this.associations.get(a))),a=b}a.aoMap&& void 0===d.attributes.uv2&& void 0!==d.attributes.uv&&d.setAttribute("uv2",d.attributes.uv),g.material=a}getMaterialType(){return i}loadMaterial(n){let e=this,o=this.json,g=this.extensions,b=o.materials[n],f,a={},h=b.extensions||{},d=[];if(h[EXTENSIONS.KHR_MATERIALS_PBR_SPECULAR_GLOSSINESS]){let i=g[EXTENSIONS.KHR_MATERIALS_PBR_SPECULAR_GLOSSINESS];f=i.getMaterialType(),d.push(i.extendParams(a,b,e))}else if(h[EXTENSIONS.KHR_MATERIALS_UNLIT]){let j=g[EXTENSIONS.KHR_MATERIALS_UNLIT];f=j.getMaterialType(),d.push(j.extendParams(a,b,e))}else{let c=b.pbrMetallicRoughness||{};if(a.color=new u(1,1,1),a.opacity=1,Array.isArray(c.baseColorFactor)){let k=c.baseColorFactor;a.color.fromArray(k),a.opacity=k[3]}void 0!==c.baseColorTexture&&d.push(e.assignTexture(a,"map",c.baseColorTexture,ah)),a.metalness=void 0!==c.metallicFactor?c.metallicFactor:1,a.roughness=void 0!==c.roughnessFactor?c.roughnessFactor:1,void 0!==c.metallicRoughnessTexture&&(d.push(e.assignTexture(a,"metalnessMap",c.metallicRoughnessTexture)),d.push(e.assignTexture(a,"roughnessMap",c.metallicRoughnessTexture))),f=this._invokeOne(function(a){return a.getMaterialType&&a.getMaterialType(n)}),d.push(Promise.all(this._invokeAll(function(b){return b.extendMaterialParams&&b.extendMaterialParams(n,a)})))}!0===b.doubleSided&&(a.side=w);let l=b.alphaMode||ALPHA_MODES.OPAQUE;if(l===ALPHA_MODES.BLEND?(a.transparent=!0,a.depthWrite=!1):(a.transparent=!1,l===ALPHA_MODES.MASK&&(a.alphaTest=void 0!==b.alphaCutoff?b.alphaCutoff:.5)),void 0!==b.normalTexture&&f!==M&&(d.push(e.assignTexture(a,"normalMap",b.normalTexture)),a.normalScale=new ae(1,1),void 0!==b.normalTexture.scale)){let m=b.normalTexture.scale;a.normalScale.set(m,m)}return void 0!==b.occlusionTexture&&f!==M&&(d.push(e.assignTexture(a,"aoMap",b.occlusionTexture)),void 0!==b.occlusionTexture.strength&&(a.aoMapIntensity=b.occlusionTexture.strength)),void 0!==b.emissiveFactor&&f!==M&&(a.emissive=new u().fromArray(b.emissiveFactor)),void 0!==b.emissiveTexture&&f!==M&&d.push(e.assignTexture(a,"emissiveMap",b.emissiveTexture,ah)),Promise.all(d).then(function(){let c;return c=f===GLTFMeshStandardSGMaterial?g[EXTENSIONS.KHR_MATERIALS_PBR_SPECULAR_GLOSSINESS].createMaterial(a):new f(a),b.name&&(c.name=b.name),assignExtrasToUserData(c,b),e.associations.set(c,{materials:n}),b.extensions&&addUnknownExtensionsToUserData(g,c,b),c})}createUniqueName(d){let b=V.sanitizeNodeName(d||""),a=b;for(let c=1;this.nodeNamesUsed[a];++c)a=b+"_"+c;return this.nodeNamesUsed[a]=!0,a}loadGeometries(e){let i=this,l=this.extensions,f=this.primitiveCache;function j(a){return l[EXTENSIONS.KHR_DRACO_MESH_COMPRESSION].decodePrimitive(a,i).then(function(b){return addPrimitiveAttributes(b,a,i)})}let b=[];for(let c=0,k=e.length;c<k;c++){let a=e[c],g=createPrimitiveKey(a),h=f[g];if(h)b.push(h.promise);else{let d;d=a.extensions&&a.extensions[EXTENSIONS.KHR_DRACO_MESH_COMPRESSION]?j(a):addPrimitiveAttributes(new t,a,i),f[g]={primitive:a,promise:d},b.push(d)}}return Promise.all(b)}loadMesh(d){let e=this,f=this.json,j=this.extensions,g=f.meshes[d],a=g.primitives,c=[];for(let b=0,h=a.length;b<h;b++){let i=void 0===a[b].material?createDefaultMaterial(this.cache):this.getDependency("material",a[b].material);c.push(i)}return c.push(e.loadGeometries(a)),Promise.all(c).then(function(l){let q=l.slice(0,l.length-1),p=l[l.length-1],f=[];for(let k=0,r=p.length;k<r;k++){let h=p[k],c=a[k],b,i=q[k];if(c.mode===WEBGL_CONSTANTS.TRIANGLES||c.mode===WEBGL_CONSTANTS.TRIANGLE_STRIP||c.mode===WEBGL_CONSTANTS.TRIANGLE_FAN|| void 0===c.mode)!0!==(b=!0===g.isSkinnedMesh?new Y(h,i):new L(h,i)).isSkinnedMesh||b.geometry.attributes.skinWeight.normalized||b.normalizeSkinWeights(),c.mode===WEBGL_CONSTANTS.TRIANGLE_STRIP?b.geometry=toTrianglesDrawMode(b.geometry,ad):c.mode===WEBGL_CONSTANTS.TRIANGLE_FAN&&(b.geometry=toTrianglesDrawMode(b.geometry,ac));else if(c.mode===WEBGL_CONSTANTS.LINES)b=new G(h,i);else if(c.mode===WEBGL_CONSTANTS.LINE_STRIP)b=new D(h,i);else if(c.mode===WEBGL_CONSTANTS.LINE_LOOP)b=new F(h,i);else if(c.mode===WEBGL_CONSTANTS.POINTS)b=new T(h,i);else throw new Error("THREE.GLTFLoader: Primitive mode unsupported: "+c.mode);Object.keys(b.geometry.morphAttributes).length>0&&updateMorphTargets(b,g),b.name=e.createUniqueName(g.name||"mesh_"+d),assignExtrasToUserData(b,g),c.extensions&&addUnknownExtensionsToUserData(j,b,c),e.assignFinalMaterial(b),f.push(b)}for(let m=0,s=f.length;m<s;m++)e.associations.set(f[m],{meshes:d,primitives:m});if(1===f.length)return f[0];let n=new z;e.associations.set(n,{meshes:d});for(let o=0,t=f.length;o<t;o++)n.add(f[o]);return n})}loadCamera(d){let c,b=this.json.cameras[d],a=b[b.type];if(!a){console.warn("THREE.GLTFLoader: Missing camera parameters.");return}return"perspective"===b.type?c=new R(J.radToDeg(a.yfov),a.aspectRatio||1,a.znear||1,a.zfar||2e6):"orthographic"===b.type&&(c=new Q(-a.xmag,a.xmag,a.ymag,-a.ymag,a.znear,a.zfar)),b.name&&(c.name=this.createUniqueName(b.name)),assignExtrasToUserData(c,b),Promise.resolve(c)}loadSkin(b){let a=this.json.skins[b],c={joints:a.joints};return void 0===a.inverseBindMatrices?Promise.resolve(c):this.getDependency("accessor",a.inverseBindMatrices).then(function(a){return c.inverseBindMatrices=a,c})}loadAnimation(l){let m=this.json,a=m.animations[l],f=[],g=[],h=[],i=[],j=[];for(let e=0,n=a.channels.length;e<n;e++){let k=a.channels[e],b=a.samplers[k.sampler],c=k.target,o=void 0!==c.node?c.node:c.id,q=void 0!==a.parameters?a.parameters[b.input]:b.input,r=void 0!==a.parameters?a.parameters[b.output]:b.output;f.push(this.getDependency("node",o)),g.push(this.getDependency("accessor",q)),h.push(this.getDependency("accessor",r)),i.push(b),j.push(c)}return Promise.all([Promise.all(f),Promise.all(g),Promise.all(h),Promise.all(i),Promise.all(j)]).then(function(f){let o=f[0],t=f[1],u=f[2],v=f[3],w=f[4],q=[];for(let b=0,x=o.length;b<x;b++){let c=o[b],y=t[b],r=u[b],i=v[b],j=w[b];if(void 0===c)continue;c.updateMatrix(),c.matrixAutoUpdate=!0;let g;switch(PATH_PROPERTIES[j.path]){case PATH_PROPERTIES.weights:g=O;break;case PATH_PROPERTIES.rotation:g=W;break;case PATH_PROPERTIES.position:case PATH_PROPERTIES.scale:default:g=ag}let z=c.name?c.name:c.uuid,A=void 0!==i.interpolation?INTERPOLATION[i.interpolation]:d,k=[];PATH_PROPERTIES[j.path]===PATH_PROPERTIES.weights?c.traverse(function(a){a.morphTargetInfluences&&k.push(a.name?a.name:a.uuid)}):k.push(z);let e=r.array;if(r.normalized){let B=getNormalizedComponentScale(e.constructor),s=new Float32Array(e.length);for(let h=0,C=e.length;h<C;h++)s[h]=e[h]*B;e=s}for(let m=0,D=k.length;m<D;m++){let n=new g(k[m]+"."+PATH_PROPERTIES[j.path],y.array,e,A);"CUBICSPLINE"===i.interpolation&&(n.createInterpolant=function(a){let b=this instanceof W?GLTFCubicSplineQuaternionInterpolant:GLTFCubicSplineInterpolant;return new b(this.times,this.values,this.getValueSize()/3,a)},n.createInterpolant.isInterpolantFactoryMethodGLTFCubicSpline=!0),q.push(n)}}let E=a.name?a.name:"animation_"+l;return new p(E,void 0,q)})}createNodeMesh(b){let c=this.json,d=this,a=c.nodes[b];return void 0===a.mesh?null:d.getDependency("mesh",a.mesh).then(function(c){let b=d._getNodeRef(d.meshCache,a.mesh,c);return void 0!==a.weights&&b.traverse(function(c){if(c.isMesh)for(let b=0,d=a.weights.length;b<d;b++)c.morphTargetInfluences[b]=a.weights[b]}),b})}loadNode(b){let c=this.json,e=this.extensions,d=this,a=c.nodes[b],f=a.name?d.createUniqueName(a.name):"";return(function(){let c=[],e=d._invokeOne(function(a){return a.createNodeMesh&&a.createNodeMesh(b)});return e&&c.push(e),void 0!==a.camera&&c.push(d.getDependency("camera",a.camera).then(function(b){return d._getNodeRef(d.cameraCache,a.camera,b)})),d._invokeAll(function(a){return a.createNodeAttachment&&a.createNodeAttachment(b)}).forEach(function(a){c.push(a)}),Promise.all(c)})().then(function(g){let c;if((c=!0===a.isBone?new q:g.length>1?new z:1===g.length?g[0]:new P)!==g[0])for(let h=0,j=g.length;h<j;h++)c.add(g[h]);if(a.name&&(c.userData.name=a.name,c.name=f),assignExtrasToUserData(c,a),a.extensions&&addUnknownExtensionsToUserData(e,c,a),void 0!==a.matrix){let i=new K;i.fromArray(a.matrix),c.applyMatrix4(i)}else void 0!==a.translation&&c.position.fromArray(a.translation),void 0!==a.rotation&&c.quaternion.fromArray(a.rotation),void 0!==a.scale&&c.scale.fromArray(a.scale);return d.associations.has(c)||d.associations.set(c,{}),d.associations.get(c).nodes=b,c})}loadScene(g){let h=this.json,i=this.extensions,a=this.json.scenes[g],d=this,b=new z;a.name&&(b.name=d.createUniqueName(a.name)),assignExtrasToUserData(b,a),a.extensions&&addUnknownExtensionsToUserData(i,b,a);let e=a.nodes||[],f=[];for(let c=0,j=e.length;c<j;c++)f.push(buildNodeHierarchy(e[c],b,h,d));return Promise.all(f).then(function(){return d.associations=(c=>{let b=new Map;for(let[a,e]of d.associations)(a instanceof I||a instanceof aa)&&b.set(a,e);return c.traverse(a=>{let c=d.associations.get(a);null!=c&&b.set(a,c)}),b})(b),b})}}function buildNodeHierarchy(a,d,b,c){let e=b.nodes[a];return c.getDependency("node",a).then(function(a){if(void 0===e.skin)return a;let b;return c.getDependency("skin",e.skin).then(function(e){b=e;let d=[];for(let a=0,f=b.joints.length;a<f;a++)d.push(c.getDependency("node",b.joints[a]));return Promise.all(d)}).then(function(c){return a.traverse(function(d){if(!d.isMesh)return;let e=[],f=[];for(let a=0,i=c.length;a<i;a++){let g=c[a];if(g){e.push(g);let h=new K;void 0!==b.inverseBindMatrices&&h.fromArray(b.inverseBindMatrices.array,16*a),f.push(h)}else console.warn('THREE.GLTFLoader: Joint "%s" could not be found.',b.joints[a])}d.bind(new X(e,f),d.matrixWorld)}),a})}).then(function(f){d.add(f);let g=[];if(e.children){let h=e.children;for(let a=0,i=h.length;a<i;a++){let j=h[a];g.push(buildNodeHierarchy(j,f,b,c))}}return Promise.all(g)})}function computeBounds(l,m,n){let o=m.attributes,a=new r;if(void 0===o.POSITION)return;{let c=n.json.accessors[o.POSITION],d=c.min,e=c.max;if(void 0!==d&& void 0!==e){if(a.set(new af(d[0],d[1],d[2]),new af(e[0],e[1],e[2])),c.normalized){let p=getNormalizedComponentScale(WEBGL_COMPONENT_TYPES[c.componentType]);a.min.multiplyScalar(p),a.max.multiplyScalar(p)}}else{console.warn("THREE.GLTFLoader: Missing min/max properties for accessor POSITION.");return}}let i=m.targets;if(void 0!==i){let q=new af,b=new af;for(let j=0,t=i.length;j<t;j++){let s=i[j];if(void 0!==s.POSITION){let f=n.json.accessors[s.POSITION],g=f.min,h=f.max;if(void 0!==g&& void 0!==h){if(b.setX(Math.max(Math.abs(g[0]),Math.abs(h[0]))),b.setY(Math.max(Math.abs(g[1]),Math.abs(h[1]))),b.setZ(Math.max(Math.abs(g[2]),Math.abs(h[2]))),f.normalized){let u=getNormalizedComponentScale(WEBGL_COMPONENT_TYPES[f.componentType]);b.multiplyScalar(u)}q.max(b)}else console.warn("THREE.GLTFLoader: Missing min/max properties for accessor POSITION.")}}a.expandByVector(q)}l.boundingBox=a;let k=new Z;a.getCenter(k.center),k.radius=a.min.distanceTo(a.max)/2,l.boundingSphere=k}function addPrimitiveAttributes(b,a,e){let f=a.attributes,c=[];function h(a,c){return e.getDependency("accessor",a).then(function(a){b.setAttribute(c,a)})}for(let d in f){let g=ATTRIBUTES[d]||d.toLowerCase();g in b.attributes||c.push(h(f[d],g))}if(void 0!==a.indices&&!b.index){let i=e.getDependency("accessor",a.indices).then(function(a){b.setIndex(a)});c.push(i)}return assignExtrasToUserData(b,a),computeBounds(b,a,e),Promise.all(c).then(function(){return void 0!==a.targets?addMorphTargets(b,a.targets,e):b})}function toTrianglesDrawMode(d,k){let a=d.getIndex();if(null===a){let h=[],i=d.getAttribute("position");if(void 0===i)return console.error("THREE.GLTFLoader.toTrianglesDrawMode(): Undefined position attribute. Processing not possible."),d;for(let f=0;f<i.count;f++)h.push(f);d.setIndex(h),a=d.getIndex()}let g=a.count-2,b=[];if(k===ac)for(let e=1;e<=g;e++)b.push(a.getX(0)),b.push(a.getX(e)),b.push(a.getX(e+1));else for(let c=0;c<g;c++)c%2==0?(b.push(a.getX(c)),b.push(a.getX(c+1)),b.push(a.getX(c+2))):(b.push(a.getX(c+2)),b.push(a.getX(c+1)),b.push(a.getX(c)));b.length/3!==g&&console.error("THREE.GLTFLoader.toTrianglesDrawMode(): Unable to generate correct amount of triangles.");let j=d.clone();return j.setIndex(b),j}export{GLTFLoader}
